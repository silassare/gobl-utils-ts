import { getEntityCache, goblMarker, toInstance } from './gobl';
const ACTION_UNKNOWN = 0, ACTION_SAVING = 1, ACTION_DELETING = 2, ACTION_UPDATING = 3;
/**
 * GoblEntity class.
 */
export default class GoblEntity {
    constructor(_initialData = {}, _name, _prefix, _columns) {
        this._name = _name;
        this._prefix = _prefix;
        this._columns = _columns;
        this._data = {};
        this._cache = {};
        this._action = ACTION_UNKNOWN;
        const ctx = this, 
        // we use null not undefined since JSON.stringify will ignore properties with undefined value
        _def = null;
        _columns.forEach(function (col) {
            ctx._data[col] = ctx._cache[col] =
                col in _initialData ? _initialData[col] : _def;
        });
    }
    /**
     * Magic setter.
     *
     * @param column
     * @param value
     */
    _set(column, value) {
        if (Object.prototype.hasOwnProperty.call(this._data, column)) {
            this._data[column] = value;
        }
        return this;
    }
    /**
     * Checks is the entity is clean.
     */
    isClean() {
        return Object.keys(this.toObject(true)).length === 0;
    }
    /**
     * Checks if the entity is saved.
     *
     * @param set When true the entity will be considered as saved.
     */
    isSaved(set) {
        if (set) {
            this._cache = this.toObject();
            return true;
        }
        return this.isClean();
    }
    /**
     * Checks if the entity is being saved.
     *
     * @param set When true the state will be set to saving.
     */
    isSaving(set) {
        if (arguments.length) {
            this._action = set ? ACTION_SAVING : ACTION_UNKNOWN;
        }
        return this._action === ACTION_SAVING;
    }
    /**
     * Checks if the entity is being deleted.
     *
     * @param set When true the state will be set to deleting.
     */
    isDeleting(set) {
        if (arguments.length) {
            this._action = set ? ACTION_DELETING : ACTION_UNKNOWN;
        }
        return this._action === ACTION_DELETING;
    }
    /**
     * Checks if the entity is being updated.
     *
     * @param set When true the state will be set to updating.
     */
    isUpdating(set) {
        if (arguments.length) {
            this._action = set ? ACTION_UPDATING : ACTION_UNKNOWN;
        }
        return this._action === ACTION_UPDATING;
    }
    /**
     * Hydrate the entity and set as saved when `save` is true
     */
    doHydrate(data, save = false) {
        const ctx = this, sourceOfTruth = this._data;
        Object.keys(data).forEach(function (k) {
            if (Object.prototype.hasOwnProperty.call(sourceOfTruth, k)) {
                ctx[k.slice(ctx._prefix.length + 1)] = data[k];
            }
        });
        if (save) {
            this.isSaved(true);
        }
        return this;
    }
    /**
     * Returns current data in a clean new object
     *
     * if `diff` is true, returns modified columns only
     */
    toObject(diff = false) {
        const o = {};
        if (diff) {
            for (const k in this._cache) {
                if (Object.prototype.hasOwnProperty.call(this._cache, k)) {
                    if (this._cache[k] !== this._data[k]) {
                        o[k] = this._data[k];
                    }
                }
            }
            return o;
        }
        for (const k in this._data) {
            if (Object.prototype.hasOwnProperty.call(this._data, k)) {
                o[k] = this._data[k];
            }
        }
        return o;
    }
    /**
     * Returns some column values
     */
    toObjectSome(columns) {
        const o = {}, len = columns.length;
        for (let i = 0; i < len; i++) {
            const col = columns[i];
            if (Object.prototype.hasOwnProperty.call(this._data, col)) {
                o[col] = this._data[col];
            }
            else {
                throw new Error(`Column "${col}" is not defined in "${this._name}".`);
            }
        }
        return o;
    }
    /**
     * JSON helper
     */
    toJSON() {
        const data = this.toObject();
        data[goblMarker] = this._name;
        return data;
    }
    /**
     * Returns the entity cache key.
     *
     * `null` is returned when we can't have a valid cache key.
     */
    cacheKey() {
        const columns = this.identifierColumns().sort(), len = columns.length;
        let value = '', i = 0;
        if (len === 1) {
            value = this._data[columns[0]];
        }
        else {
            for (; i < len; i++) {
                const v = this._data[columns[i]];
                if (v != null) {
                    value += v;
                }
            }
        }
        return value || null;
    }
    /**
     * For backward compatibility
     */
    toInstance(data, cache = false) {
        return toInstance(data, cache);
    }
    /**
     * For backward compatibility
     */
    subCache(entityName) {
        return getEntityCache(entityName);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR29ibEVudGl0eS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9Hb2JsRW50aXR5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxjQUFjLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQU1oRSxNQUFNLGNBQWMsR0FBRyxDQUFDLEVBQ3ZCLGFBQWEsR0FBRyxDQUFDLEVBQ2pCLGVBQWUsR0FBRyxDQUFDLEVBQ25CLGVBQWUsR0FBRyxDQUFDLENBQUM7QUFFckI7O0dBRUc7QUFDSCxNQUFNLENBQUMsT0FBTyxPQUFnQixVQUFVO0lBS3ZDLFlBQ0MsZUFBK0IsRUFBRSxFQUNoQixLQUFhLEVBQ2IsT0FBZSxFQUNmLFFBQWtCO1FBRmxCLFVBQUssR0FBTCxLQUFLLENBQVE7UUFDYixZQUFPLEdBQVAsT0FBTyxDQUFRO1FBQ2YsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQVJqQixVQUFLLEdBQVEsRUFBRSxDQUFDO1FBQ3pCLFdBQU0sR0FBUSxFQUFFLENBQUM7UUFDakIsWUFBTyxHQUFXLGNBQWMsQ0FBQztRQVExQyxNQUFNLEdBQUcsR0FBRyxJQUFJO1FBQ2YsNkZBQTZGO1FBQzdGLElBQUksR0FBRyxJQUFJLENBQUM7UUFFYixRQUFRLENBQUMsT0FBTyxDQUFDLFVBQVUsR0FBRztZQUM3QixHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDO2dCQUMvQixHQUFHLElBQUksWUFBWSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUNqRCxDQUFDLENBQUMsQ0FBQztJQUNKLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNPLElBQUksQ0FBQyxNQUFjLEVBQUUsS0FBVTtRQUN4QyxJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLENB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QztRQUM3QixJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUU5QixPQUFPLElBQUksQ0FBQztJQUNiLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsUUFBUTtRQUNQLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLElBQUksRUFBRSxFQUM5QyxHQUFHLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztRQUN0QixJQUFJLEtBQUssR0FBRyxFQUFFLEVBQ2IsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUVQLElBQUksR0FBRyxLQUFLLENBQUMsRUFBRTtZQUNkLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQy9CO2FBQU07WUFDTixPQUFPLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQ3BCLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2pDLElBQUksQ0FBQyxJQUFJLElBQUksRUFBRTtvQkFDZCxLQUFLLElBQUksQ0FBQyxDQUFDO2lCQUNYO2FBQ0Q7U0FDRDtRQUVELE9BQU8sS0FBSyxJQUFJLElBQUksQ0FBQztJQUN0QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxVQUFVLENBQUMsSUFBb0IsRUFBRSxLQUFLLEdBQUcsS0FBSztRQUM3QyxPQUFPLFVBQVUsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsUUFBUSxDQUFDLFVBQWtCO1FBQzFCLE9BQU8sY0FBYyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ25DLENBQUM7Q0FNRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdldEVudGl0eUNhY2hlLCBnb2JsTWFya2VyLCB0b0luc3RhbmNlIH0gZnJvbSAnLi9nb2JsJztcblxuZXhwb3J0IHR5cGUgR29ibEVudGl0eURhdGEgPSB7XG5cdFtrZXk6IHN0cmluZ106IGFueTtcbn07XG5cbmNvbnN0IEFDVElPTl9VTktOT1dOID0gMCxcblx0QUNUSU9OX1NBVklORyA9IDEsXG5cdEFDVElPTl9ERUxFVElORyA9IDIsXG5cdEFDVElPTl9VUERBVElORyA9IDM7XG5cbi8qKlxuICogR29ibEVudGl0eSBjbGFzcy5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgYWJzdHJhY3QgY2xhc3MgR29ibEVudGl0eSB7XG5cdHByb3RlY3RlZCByZWFkb25seSBfZGF0YTogYW55ID0ge307XG5cdHByb3RlY3RlZCBfY2FjaGU6IGFueSA9IHt9O1xuXHRwcm90ZWN0ZWQgX2FjdGlvbjogbnVtYmVyID0gQUNUSU9OX1VOS05PV047XG5cblx0cHJvdGVjdGVkIGNvbnN0cnVjdG9yKFxuXHRcdF9pbml0aWFsRGF0YTogR29ibEVudGl0eURhdGEgPSB7fSxcblx0XHRwcml2YXRlIHJlYWRvbmx5IF9uYW1lOiBzdHJpbmcsXG5cdFx0cHJpdmF0ZSByZWFkb25seSBfcHJlZml4OiBzdHJpbmcsXG5cdFx0cHJpdmF0ZSByZWFkb25seSBfY29sdW1uczogc3RyaW5nW10sXG5cdCkge1xuXHRcdGNvbnN0IGN0eCA9IHRoaXMsXG5cdFx0XHQvLyB3ZSB1c2UgbnVsbCBub3QgdW5kZWZpbmVkIHNpbmNlIEpTT04uc3RyaW5naWZ5IHdpbGwgaWdub3JlIHByb3BlcnRpZXMgd2l0aCB1bmRlZmluZWQgdmFsdWVcblx0XHRcdF9kZWYgPSBudWxsO1xuXG5cdFx0X2NvbHVtbnMuZm9yRWFjaChmdW5jdGlvbiAoY29sKSB7XG5cdFx0XHRjdHguX2RhdGFbY29sXSA9IGN0eC5fY2FjaGVbY29sXSA9XG5cdFx0XHRcdGNvbCBpbiBfaW5pdGlhbERhdGEgPyBfaW5pdGlhbERhdGFbY29sXSA6IF9kZWY7XG5cdFx0fSk7XG5cdH1cblxuXHQvKipcblx0ICogTWFnaWMgc2V0dGVyLlxuXHQgKlxuXHQgKiBAcGFyYW0gY29sdW1uXG5cdCAqIEBwYXJhbSB2YWx1ZVxuXHQgKi9cblx0cHJvdGVjdGVkIF9zZXQoY29sdW1uOiBzdHJpbmcsIHZhbHVlOiBhbnkpOiB0aGlzIHtcblx0XHRpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMuX2RhdGEsIGNvbHVtbikpIHtcblx0XHRcdHRoaXMuX2RhdGFbY29sdW1uXSA9IHZhbHVlO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0LyoqXG5cdCAqIENoZWNrcyBpcyB0aGUgZW50aXR5IGlzIGNsZWFuLlxuXHQgKi9cblx0aXNDbGVhbigpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gT2JqZWN0LmtleXModGhpcy50b09iamVjdCh0cnVlKSkubGVuZ3RoID09PSAwO1xuXHR9XG5cblx0LyoqXG5cdCAqIENoZWNrcyBpZiB0aGUgZW50aXR5IGlzIHNhdmVkLlxuXHQgKlxuXHQgKiBAcGFyYW0gc2V0IFdoZW4gdHJ1ZSB0aGUgZW50aXR5IHdpbGwgYmUgY29uc2lkZXJlZCBhcyBzYXZlZC5cblx0ICovXG5cdGlzU2F2ZWQoc2V0PzogYm9vbGVhbik6IGJvb2xlYW4ge1xuXHRcdGlmIChzZXQpIHtcblx0XHRcdHRoaXMuX2NhY2hlID0gdGhpcy50b09iamVjdCgpO1xuXHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuaXNDbGVhbigpO1xuXHR9XG5cblx0LyoqXG5cdCAqIENoZWNrcyBpZiB0aGUgZW50aXR5IGlzIGJlaW5nIHNhdmVkLlxuXHQgKlxuXHQgKiBAcGFyYW0gc2V0IFdoZW4gdHJ1ZSB0aGUgc3RhdGUgd2lsbCBiZSBzZXQgdG8gc2F2aW5nLlxuXHQgKi9cblx0aXNTYXZpbmcoc2V0PzogYm9vbGVhbik6IGJvb2xlYW4ge1xuXHRcdGlmIChhcmd1bWVudHMubGVuZ3RoKSB7XG5cdFx0XHR0aGlzLl9hY3Rpb24gPSBzZXQgPyBBQ1RJT05fU0FWSU5HIDogQUNUSU9OX1VOS05PV047XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuX2FjdGlvbiA9PT0gQUNUSU9OX1NBVklORztcblx0fVxuXG5cdC8qKlxuXHQgKiBDaGVja3MgaWYgdGhlIGVudGl0eSBpcyBiZWluZyBkZWxldGVkLlxuXHQgKlxuXHQgKiBAcGFyYW0gc2V0IFdoZW4gdHJ1ZSB0aGUgc3RhdGUgd2lsbCBiZSBzZXQgdG8gZGVsZXRpbmcuXG5cdCAqL1xuXHRpc0RlbGV0aW5nKHNldD86IGJvb2xlYW4pOiBib29sZWFuIHtcblx0XHRpZiAoYXJndW1lbnRzLmxlbmd0aCkge1xuXHRcdFx0dGhpcy5fYWN0aW9uID0gc2V0ID8gQUNUSU9OX0RFTEVUSU5HIDogQUNUSU9OX1VOS05PV047XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuX2FjdGlvbiA9PT0gQUNUSU9OX0RFTEVUSU5HO1xuXHR9XG5cblx0LyoqXG5cdCAqIENoZWNrcyBpZiB0aGUgZW50aXR5IGlzIGJlaW5nIHVwZGF0ZWQuXG5cdCAqXG5cdCAqIEBwYXJhbSBzZXQgV2hlbiB0cnVlIHRoZSBzdGF0ZSB3aWxsIGJlIHNldCB0byB1cGRhdGluZy5cblx0ICovXG5cdGlzVXBkYXRpbmcoc2V0PzogYm9vbGVhbik6IGJvb2xlYW4ge1xuXHRcdGlmIChhcmd1bWVudHMubGVuZ3RoKSB7XG5cdFx0XHR0aGlzLl9hY3Rpb24gPSBzZXQgPyBBQ1RJT05fVVBEQVRJTkcgOiBBQ1RJT05fVU5LTk9XTjtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5fYWN0aW9uID09PSBBQ1RJT05fVVBEQVRJTkc7XG5cdH1cblxuXHQvKipcblx0ICogSHlkcmF0ZSB0aGUgZW50aXR5IGFuZCBzZXQgYXMgc2F2ZWQgd2hlbiBgc2F2ZWAgaXMgdHJ1ZVxuXHQgKi9cblx0ZG9IeWRyYXRlKGRhdGE6IEdvYmxFbnRpdHlEYXRhLCBzYXZlID0gZmFsc2UpOiB0aGlzIHtcblx0XHRjb25zdCBjdHggPSB0aGlzLFxuXHRcdFx0c291cmNlT2ZUcnV0aCA9IHRoaXMuX2RhdGE7XG5cblx0XHRPYmplY3Qua2V5cyhkYXRhKS5mb3JFYWNoKGZ1bmN0aW9uIChrKSB7XG5cdFx0XHRpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHNvdXJjZU9mVHJ1dGgsIGspKSB7XG5cdFx0XHRcdChjdHggYXMgYW55KVtrLnNsaWNlKGN0eC5fcHJlZml4Lmxlbmd0aCArIDEpXSA9IGRhdGFba107XG5cdFx0XHR9XG5cdFx0fSk7XG5cblx0XHRpZiAoc2F2ZSkge1xuXHRcdFx0dGhpcy5pc1NhdmVkKHRydWUpO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgY3VycmVudCBkYXRhIGluIGEgY2xlYW4gbmV3IG9iamVjdFxuXHQgKlxuXHQgKiBpZiBgZGlmZmAgaXMgdHJ1ZSwgcmV0dXJucyBtb2RpZmllZCBjb2x1bW5zIG9ubHlcblx0ICovXG5cdHRvT2JqZWN0KGRpZmYgPSBmYWxzZSk6IEdvYmxFbnRpdHlEYXRhIHtcblx0XHRjb25zdCBvOiBhbnkgPSB7fTtcblxuXHRcdGlmIChkaWZmKSB7XG5cdFx0XHRmb3IgKGNvbnN0IGsgaW4gdGhpcy5fY2FjaGUpIHtcblx0XHRcdFx0aWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLl9jYWNoZSwgaykpIHtcblx0XHRcdFx0XHRpZiAodGhpcy5fY2FjaGVba10gIT09IHRoaXMuX2RhdGFba10pIHtcblx0XHRcdFx0XHRcdG9ba10gPSB0aGlzLl9kYXRhW2tdO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdFx0cmV0dXJuIG87XG5cdFx0fVxuXG5cdFx0Zm9yIChjb25zdCBrIGluIHRoaXMuX2RhdGEpIHtcblx0XHRcdGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGhpcy5fZGF0YSwgaykpIHtcblx0XHRcdFx0b1trXSA9IHRoaXMuX2RhdGFba107XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIG87XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyBzb21lIGNvbHVtbiB2YWx1ZXNcblx0ICovXG5cdHRvT2JqZWN0U29tZShjb2x1bW5zOiBzdHJpbmdbXSk6IEdvYmxFbnRpdHlEYXRhIHtcblx0XHRjb25zdCBvOiBhbnkgPSB7fSxcblx0XHRcdGxlbiA9IGNvbHVtbnMubGVuZ3RoO1xuXG5cdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykge1xuXHRcdFx0Y29uc3QgY29sID0gY29sdW1uc1tpXTtcblx0XHRcdGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGhpcy5fZGF0YSwgY29sKSkge1xuXHRcdFx0XHRvW2NvbF0gPSB0aGlzLl9kYXRhW2NvbF07XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoXG5cdFx0XHRcdFx0YENvbHVtbiBcIiR7Y29sfVwiIGlzIG5vdCBkZWZpbmVkIGluIFwiJHt0aGlzLl9uYW1lfVwiLmAsXG5cdFx0XHRcdCk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIG87XG5cdH1cblxuXHQvKipcblx0ICogSlNPTiBoZWxwZXJcblx0ICovXG5cdHRvSlNPTigpOiBhbnkge1xuXHRcdGNvbnN0IGRhdGEgPSB0aGlzLnRvT2JqZWN0KCk7XG5cdFx0ZGF0YVtnb2JsTWFya2VyXSA9IHRoaXMuX25hbWU7XG5cblx0XHRyZXR1cm4gZGF0YTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHRoZSBlbnRpdHkgY2FjaGUga2V5LlxuXHQgKlxuXHQgKiBgbnVsbGAgaXMgcmV0dXJuZWQgd2hlbiB3ZSBjYW4ndCBoYXZlIGEgdmFsaWQgY2FjaGUga2V5LlxuXHQgKi9cblx0Y2FjaGVLZXkoKTogc3RyaW5nIHwgbnVsbCB7XG5cdFx0Y29uc3QgY29sdW1ucyA9IHRoaXMuaWRlbnRpZmllckNvbHVtbnMoKS5zb3J0KCksXG5cdFx0XHRsZW4gPSBjb2x1bW5zLmxlbmd0aDtcblx0XHRsZXQgdmFsdWUgPSAnJyxcblx0XHRcdGkgPSAwO1xuXG5cdFx0aWYgKGxlbiA9PT0gMSkge1xuXHRcdFx0dmFsdWUgPSB0aGlzLl9kYXRhW2NvbHVtbnNbMF1dO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRmb3IgKDsgaSA8IGxlbjsgaSsrKSB7XG5cdFx0XHRcdGNvbnN0IHYgPSB0aGlzLl9kYXRhW2NvbHVtbnNbaV1dO1xuXHRcdFx0XHRpZiAodiAhPSBudWxsKSB7XG5cdFx0XHRcdFx0dmFsdWUgKz0gdjtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiB2YWx1ZSB8fCBudWxsO1xuXHR9XG5cblx0LyoqXG5cdCAqIEZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5XG5cdCAqL1xuXHR0b0luc3RhbmNlKGRhdGE6IEdvYmxFbnRpdHlEYXRhLCBjYWNoZSA9IGZhbHNlKSB7XG5cdFx0cmV0dXJuIHRvSW5zdGFuY2UoZGF0YSwgY2FjaGUpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5XG5cdCAqL1xuXHRzdWJDYWNoZShlbnRpdHlOYW1lOiBzdHJpbmcpIHtcblx0XHRyZXR1cm4gZ2V0RW50aXR5Q2FjaGUoZW50aXR5TmFtZSk7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyB0aGUgcHJpbWFyeSBrZXlzIG9mIHRoZSBlbnRpdHkuXG5cdCAqL1xuXHRhYnN0cmFjdCBpZGVudGlmaWVyQ29sdW1ucygpOiBzdHJpbmdbXTtcbn1cbiJdfQ==