import { getEntityCache, goblMarker, toInstance } from './gobl.js';
var GoblEntityState;
(function (GoblEntityState) {
    GoblEntityState[GoblEntityState["UNKNOWN"] = 0] = "UNKNOWN";
    GoblEntityState[GoblEntityState["SAVING"] = 1] = "SAVING";
    GoblEntityState[GoblEntityState["DELETING"] = 2] = "DELETING";
    GoblEntityState[GoblEntityState["UPDATING"] = 3] = "UPDATING";
})(GoblEntityState || (GoblEntityState = {}));
/**
 * GoblEntity class.
 */
export default class GoblEntity {
    _name;
    _prefix;
    _columns;
    _data = {};
    _cache = {};
    _state = GoblEntityState.UNKNOWN;
    constructor(_initialData = {}, _name, _prefix, _columns) {
        this._name = _name;
        this._prefix = _prefix;
        this._columns = _columns;
        const ctx = this, 
        // we use null not undefined since JSON.stringify will ignore properties with undefined value
        _def = null;
        this._columns.forEach(function (col) {
            ctx._data[col] = ctx._cache[col] =
                col in _initialData ? _initialData[col] : _def;
        });
    }
    /**
     * Magic setter.
     *
     * @param column
     * @param value
     */
    _set(column, value) {
        if (Object.prototype.hasOwnProperty.call(this._data, column)) {
            this._data[column] = value;
        }
        return this;
    }
    /**
     * Checks if the entity is clean.
     */
    isClean() {
        return Object.keys(this.toObject(true)).length === 0;
    }
    /**
     * Checks if the entity is saved.
     *
     * @param set When true the entity will be considered as saved.
     */
    isSaved(set) {
        if (set) {
            this._cache = this.toObject();
            return true;
        }
        return this.isClean();
    }
    /**
     * Checks if the entity is being saved.
     *
     * @param set When true the state will be set to saving.
     */
    isSaving(set) {
        if (arguments.length) {
            this._state = set ? GoblEntityState.SAVING : GoblEntityState.UNKNOWN;
        }
        return this._state === GoblEntityState.SAVING;
    }
    /**
     * Checks if the entity is being deleted.
     *
     * @param set When true the state will be set to deleting.
     */
    isDeleting(set) {
        if (arguments.length) {
            this._state = set ? GoblEntityState.DELETING : GoblEntityState.UNKNOWN;
        }
        return this._state === GoblEntityState.DELETING;
    }
    /**
     * Checks if the entity is being updated.
     *
     * @param set When true the state will be set to updating.
     */
    isUpdating(set) {
        if (arguments.length) {
            this._state = set ? GoblEntityState.UPDATING : GoblEntityState.UNKNOWN;
        }
        return this._state === GoblEntityState.UPDATING;
    }
    /**
     * Hydrate the entity and set as saved when `save` is true
     */
    doHydrate(data, save = false) {
        const ctx = this, sourceOfTruth = this._data;
        Object.keys(data).forEach(function (k) {
            if (Object.prototype.hasOwnProperty.call(sourceOfTruth, k)) {
                ctx[k.slice(ctx._prefix.length + 1)] = data[k];
            }
        });
        if (save) {
            this.isSaved(true);
        }
        return this;
    }
    /**
     * Returns current data in a clean new object
     *
     * if `diff` is true, returns modified columns only
     */
    toObject(diff = false) {
        const o = {};
        if (diff) {
            for (const k in this._cache) {
                if (Object.prototype.hasOwnProperty.call(this._cache, k)) {
                    if (this._cache[k] !== this._data[k]) {
                        o[k] = this._data[k];
                    }
                }
            }
            return o;
        }
        for (const k in this._data) {
            if (Object.prototype.hasOwnProperty.call(this._data, k)) {
                o[k] = this._data[k];
            }
        }
        return o;
    }
    /**
     * Returns some column values
     */
    toObjectSome(columns) {
        const o = {}, len = columns.length;
        for (let i = 0; i < len; i++) {
            const col = columns[i];
            if (Object.prototype.hasOwnProperty.call(this._data, col)) {
                o[col] = this._data[col];
            }
            else {
                throw new Error(`Column "${col}" is not defined in "${this._name}".`);
            }
        }
        return o;
    }
    /**
     * JSON helper
     */
    toJSON() {
        const data = this.toObject();
        data[goblMarker] = this._name;
        return data;
    }
    /**
     * Returns the entity cache key.
     *
     * `null` is returned when we can't have a valid cache key.
     */
    cacheKey() {
        const columns = this.identifierColumns().sort(), len = columns.length;
        let value = '', i = 0;
        if (len === 1) {
            value = this._data[columns[0]];
        }
        else {
            for (; i < len; i++) {
                const v = this._data[columns[i]];
                if (v != null) {
                    value += '|' + v;
                }
            }
        }
        return value || null;
    }
    /**
     * For backward compatibility
     */
    toInstance(data, cache = false) {
        return toInstance(data, cache);
    }
    /**
     * For backward compatibility
     */
    subCache(entityName) {
        return getEntityCache(entityName);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR29ibEVudGl0eS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Hb2JsRW50aXR5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxjQUFjLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQU1uRSxJQUFLLGVBS0o7QUFMRCxXQUFLLGVBQWU7SUFDbkIsMkRBQU8sQ0FBQTtJQUNQLHlEQUFNLENBQUE7SUFDTiw2REFBUSxDQUFBO0lBQ1IsNkRBQVEsQ0FBQTtBQUNULENBQUMsRUFMSSxlQUFlLEtBQWYsZUFBZSxRQUtuQjtBQUVEOztHQUVHO0FBQ0gsTUFBTSxDQUFDLE9BQU8sT0FBZ0IsVUFBVTtJQU9yQjtJQUNBO0lBQ0E7SUFSQyxLQUFLLEdBQVEsRUFBRSxDQUFDO0lBQ3pCLE1BQU0sR0FBUSxFQUFFLENBQUM7SUFDakIsTUFBTSxHQUFvQixlQUFlLENBQUMsT0FBTyxDQUFDO0lBRTVELFlBQ0MsZUFBK0IsRUFBRSxFQUNoQixLQUFhLEVBQ2IsT0FBZSxFQUNmLFFBQWtCO1FBRmxCLFVBQUssR0FBTCxLQUFLLENBQVE7UUFDYixZQUFPLEdBQVAsT0FBTyxDQUFRO1FBQ2YsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUVuQyxNQUFNLEdBQUcsR0FBRyxJQUFJO1FBQ2YsNkZBQTZGO1FBQzdGLElBQUksR0FBRyxJQUFJLENBQUM7UUFFYixJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEdBQUc7WUFDbEMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQztnQkFDL0IsR0FBRyxJQUFJLFlBQVksQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDakQsQ0FBQyxDQUFDLENBQUM7SUFDSixDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDTyxJQUFJLENBQUMsTUFBYyxFQUFFLEtBQVU7UUFDeEMsSUFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsRUFBRSxDQUFDO1lBQzlELElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsS0FBSyxDQUFDO1FBQzVCLENBQUM7UUFFRCxPQUFPLElBQUksQ0FBQztJQUNiLENBQUM7SUFFRDs7T0FFRztJQUNILE9BQU87UUFDTixPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxPQUFPLENBQUMsR0FBYTtRQUNwQixJQUFJLEdBQUcsRUFBRSxDQUFDO1lBQ1QsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDOUIsT0FBTyxJQUFJLENBQUM7UUFDYixDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxRQUFRLENBQUMsR0FBYTtRQUNyQixJQUFJLFNBQVMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUN0QixJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQztRQUN0RSxDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUMsTUFBTSxLQUFLLGVBQWUsQ0FBQyxNQUFNLENBQUM7SUFDL0MsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxVQUFVLENBQUMsR0FBYTtRQUN2QixJQUFJLFNBQVMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUN0QixJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQztRQUN4RSxDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUMsTUFBTSxLQUFLLGVBQWUsQ0FBQyxRQUFRLENBQUM7SUFDakQsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxVQUFVLENBQUMsR0FBYTtRQUN2QixJQUFJLFNBQVMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUN0QixJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQztRQUN4RSxDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUMsTUFBTSxLQUFLLGVBQWUsQ0FBQyxRQUFRLENBQUM7SUFDakQsQ0FBQztJQUVEOztPQUVHO0lBQ0gsU0FBUyxDQUFDLElBQW9CLEVBQUUsSUFBSSxHQUFHLEtBQUs7UUFDM0MsTUFBTSxHQUFHLEdBQUcsSUFBSSxFQUNmLGFBQWEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBRTVCLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQztZQUNwQyxJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQztnQkFDM0QsR0FBVyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDekQsQ0FBQztRQUNGLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxJQUFJLEVBQUUsQ0FBQztZQUNWLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDcEIsQ0FBQztRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxRQUFRLENBQUMsSUFBSSxHQUFHLEtBQUs7UUFDcEIsTUFBTSxDQUFDLEdBQVEsRUFBRSxDQUFDO1FBRWxCLElBQUksSUFBSSxFQUFFLENBQUM7WUFDVixLQUFLLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDN0IsSUFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDO29CQUMxRCxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO3dCQUN0QyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDdEIsQ0FBQztnQkFDRixDQUFDO1lBQ0YsQ0FBQztZQUNELE9BQU8sQ0FBQyxDQUFDO1FBQ1YsQ0FBQztRQUVELEtBQUssTUFBTSxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQzVCLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQztnQkFDekQsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEIsQ0FBQztRQUNGLENBQUM7UUFFRCxPQUFPLENBQUMsQ0FBQztJQUNWLENBQUM7SUFFRDs7T0FFRztJQUNILFlBQVksQ0FBQyxPQUFpQjtRQUM3QixNQUFNLENBQUMsR0FBUSxFQUFFLEVBQ2hCLEdBQUcsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO1FBRXRCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUM5QixNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdkIsSUFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDO2dCQUMzRCxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUMxQixDQUFDO2lCQUFNLENBQUM7Z0JBQ1AsTUFBTSxJQUFJLEtBQUssQ0FBQyxXQUFXLEdBQUcsd0JBQXdCLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDO1lBQ3ZFLENBQUM7UUFDRixDQUFDO1FBRUQsT0FBTyxDQUFDLENBQUM7SUFDVixDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNO1FBQ0wsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzdCLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBRTlCLE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxRQUFRO1FBQ1AsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUMsSUFBSSxFQUFFLEVBQzlDLEdBQUcsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO1FBQ3RCLElBQUksS0FBSyxHQUFHLEVBQUUsRUFDYixDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRVAsSUFBSSxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDZixLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNoQyxDQUFDO2FBQU0sQ0FBQztZQUNQLE9BQU8sQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO2dCQUNyQixNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNqQyxJQUFJLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQztvQkFDZixLQUFLLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQztnQkFDbEIsQ0FBQztZQUNGLENBQUM7UUFDRixDQUFDO1FBRUQsT0FBTyxLQUFLLElBQUksSUFBSSxDQUFDO0lBQ3RCLENBQUM7SUFFRDs7T0FFRztJQUNILFVBQVUsQ0FBQyxJQUFvQixFQUFFLEtBQUssR0FBRyxLQUFLO1FBQzdDLE9BQU8sVUFBVSxDQUFPLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxRQUFRLENBQUMsVUFBa0I7UUFDMUIsT0FBTyxjQUFjLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDbkMsQ0FBQztDQU1EIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZ2V0RW50aXR5Q2FjaGUsIGdvYmxNYXJrZXIsIHRvSW5zdGFuY2UgfSBmcm9tICcuL2dvYmwuanMnO1xuXG5leHBvcnQgdHlwZSBHb2JsRW50aXR5RGF0YSA9IHtcblx0W2tleTogc3RyaW5nXTogYW55O1xufTtcblxuZW51bSBHb2JsRW50aXR5U3RhdGUge1xuXHRVTktOT1dOLFxuXHRTQVZJTkcsXG5cdERFTEVUSU5HLFxuXHRVUERBVElORyxcbn1cblxuLyoqXG4gKiBHb2JsRW50aXR5IGNsYXNzLlxuICovXG5leHBvcnQgZGVmYXVsdCBhYnN0cmFjdCBjbGFzcyBHb2JsRW50aXR5IHtcblx0cHJvdGVjdGVkIHJlYWRvbmx5IF9kYXRhOiBhbnkgPSB7fTtcblx0cHJvdGVjdGVkIF9jYWNoZTogYW55ID0ge307XG5cdHByb3RlY3RlZCBfc3RhdGU6IEdvYmxFbnRpdHlTdGF0ZSA9IEdvYmxFbnRpdHlTdGF0ZS5VTktOT1dOO1xuXG5cdHByb3RlY3RlZCBjb25zdHJ1Y3Rvcihcblx0XHRfaW5pdGlhbERhdGE6IEdvYmxFbnRpdHlEYXRhID0ge30sXG5cdFx0cHJpdmF0ZSByZWFkb25seSBfbmFtZTogc3RyaW5nLFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgX3ByZWZpeDogc3RyaW5nLFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgX2NvbHVtbnM6IHN0cmluZ1tdXG5cdCkge1xuXHRcdGNvbnN0IGN0eCA9IHRoaXMsXG5cdFx0XHQvLyB3ZSB1c2UgbnVsbCBub3QgdW5kZWZpbmVkIHNpbmNlIEpTT04uc3RyaW5naWZ5IHdpbGwgaWdub3JlIHByb3BlcnRpZXMgd2l0aCB1bmRlZmluZWQgdmFsdWVcblx0XHRcdF9kZWYgPSBudWxsO1xuXG5cdFx0dGhpcy5fY29sdW1ucy5mb3JFYWNoKGZ1bmN0aW9uIChjb2wpIHtcblx0XHRcdGN0eC5fZGF0YVtjb2xdID0gY3R4Ll9jYWNoZVtjb2xdID1cblx0XHRcdFx0Y29sIGluIF9pbml0aWFsRGF0YSA/IF9pbml0aWFsRGF0YVtjb2xdIDogX2RlZjtcblx0XHR9KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBNYWdpYyBzZXR0ZXIuXG5cdCAqXG5cdCAqIEBwYXJhbSBjb2x1bW5cblx0ICogQHBhcmFtIHZhbHVlXG5cdCAqL1xuXHRwcm90ZWN0ZWQgX3NldChjb2x1bW46IHN0cmluZywgdmFsdWU6IGFueSk6IHRoaXMge1xuXHRcdGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGhpcy5fZGF0YSwgY29sdW1uKSkge1xuXHRcdFx0dGhpcy5fZGF0YVtjb2x1bW5dID0gdmFsdWU7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQvKipcblx0ICogQ2hlY2tzIGlmIHRoZSBlbnRpdHkgaXMgY2xlYW4uXG5cdCAqL1xuXHRpc0NsZWFuKCk6IGJvb2xlYW4ge1xuXHRcdHJldHVybiBPYmplY3Qua2V5cyh0aGlzLnRvT2JqZWN0KHRydWUpKS5sZW5ndGggPT09IDA7XG5cdH1cblxuXHQvKipcblx0ICogQ2hlY2tzIGlmIHRoZSBlbnRpdHkgaXMgc2F2ZWQuXG5cdCAqXG5cdCAqIEBwYXJhbSBzZXQgV2hlbiB0cnVlIHRoZSBlbnRpdHkgd2lsbCBiZSBjb25zaWRlcmVkIGFzIHNhdmVkLlxuXHQgKi9cblx0aXNTYXZlZChzZXQ/OiBib29sZWFuKTogYm9vbGVhbiB7XG5cdFx0aWYgKHNldCkge1xuXHRcdFx0dGhpcy5fY2FjaGUgPSB0aGlzLnRvT2JqZWN0KCk7XG5cdFx0XHRyZXR1cm4gdHJ1ZTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5pc0NsZWFuKCk7XG5cdH1cblxuXHQvKipcblx0ICogQ2hlY2tzIGlmIHRoZSBlbnRpdHkgaXMgYmVpbmcgc2F2ZWQuXG5cdCAqXG5cdCAqIEBwYXJhbSBzZXQgV2hlbiB0cnVlIHRoZSBzdGF0ZSB3aWxsIGJlIHNldCB0byBzYXZpbmcuXG5cdCAqL1xuXHRpc1NhdmluZyhzZXQ/OiBib29sZWFuKTogYm9vbGVhbiB7XG5cdFx0aWYgKGFyZ3VtZW50cy5sZW5ndGgpIHtcblx0XHRcdHRoaXMuX3N0YXRlID0gc2V0ID8gR29ibEVudGl0eVN0YXRlLlNBVklORyA6IEdvYmxFbnRpdHlTdGF0ZS5VTktOT1dOO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzLl9zdGF0ZSA9PT0gR29ibEVudGl0eVN0YXRlLlNBVklORztcblx0fVxuXG5cdC8qKlxuXHQgKiBDaGVja3MgaWYgdGhlIGVudGl0eSBpcyBiZWluZyBkZWxldGVkLlxuXHQgKlxuXHQgKiBAcGFyYW0gc2V0IFdoZW4gdHJ1ZSB0aGUgc3RhdGUgd2lsbCBiZSBzZXQgdG8gZGVsZXRpbmcuXG5cdCAqL1xuXHRpc0RlbGV0aW5nKHNldD86IGJvb2xlYW4pOiBib29sZWFuIHtcblx0XHRpZiAoYXJndW1lbnRzLmxlbmd0aCkge1xuXHRcdFx0dGhpcy5fc3RhdGUgPSBzZXQgPyBHb2JsRW50aXR5U3RhdGUuREVMRVRJTkcgOiBHb2JsRW50aXR5U3RhdGUuVU5LTk9XTjtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5fc3RhdGUgPT09IEdvYmxFbnRpdHlTdGF0ZS5ERUxFVElORztcblx0fVxuXG5cdC8qKlxuXHQgKiBDaGVja3MgaWYgdGhlIGVudGl0eSBpcyBiZWluZyB1cGRhdGVkLlxuXHQgKlxuXHQgKiBAcGFyYW0gc2V0IFdoZW4gdHJ1ZSB0aGUgc3RhdGUgd2lsbCBiZSBzZXQgdG8gdXBkYXRpbmcuXG5cdCAqL1xuXHRpc1VwZGF0aW5nKHNldD86IGJvb2xlYW4pOiBib29sZWFuIHtcblx0XHRpZiAoYXJndW1lbnRzLmxlbmd0aCkge1xuXHRcdFx0dGhpcy5fc3RhdGUgPSBzZXQgPyBHb2JsRW50aXR5U3RhdGUuVVBEQVRJTkcgOiBHb2JsRW50aXR5U3RhdGUuVU5LTk9XTjtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5fc3RhdGUgPT09IEdvYmxFbnRpdHlTdGF0ZS5VUERBVElORztcblx0fVxuXG5cdC8qKlxuXHQgKiBIeWRyYXRlIHRoZSBlbnRpdHkgYW5kIHNldCBhcyBzYXZlZCB3aGVuIGBzYXZlYCBpcyB0cnVlXG5cdCAqL1xuXHRkb0h5ZHJhdGUoZGF0YTogR29ibEVudGl0eURhdGEsIHNhdmUgPSBmYWxzZSk6IHRoaXMge1xuXHRcdGNvbnN0IGN0eCA9IHRoaXMsXG5cdFx0XHRzb3VyY2VPZlRydXRoID0gdGhpcy5fZGF0YTtcblxuXHRcdE9iamVjdC5rZXlzKGRhdGEpLmZvckVhY2goZnVuY3Rpb24gKGspIHtcblx0XHRcdGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc291cmNlT2ZUcnV0aCwgaykpIHtcblx0XHRcdFx0KGN0eCBhcyBhbnkpW2suc2xpY2UoY3R4Ll9wcmVmaXgubGVuZ3RoICsgMSldID0gZGF0YVtrXTtcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdGlmIChzYXZlKSB7XG5cdFx0XHR0aGlzLmlzU2F2ZWQodHJ1ZSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyBjdXJyZW50IGRhdGEgaW4gYSBjbGVhbiBuZXcgb2JqZWN0XG5cdCAqXG5cdCAqIGlmIGBkaWZmYCBpcyB0cnVlLCByZXR1cm5zIG1vZGlmaWVkIGNvbHVtbnMgb25seVxuXHQgKi9cblx0dG9PYmplY3QoZGlmZiA9IGZhbHNlKTogR29ibEVudGl0eURhdGEge1xuXHRcdGNvbnN0IG86IGFueSA9IHt9O1xuXG5cdFx0aWYgKGRpZmYpIHtcblx0XHRcdGZvciAoY29uc3QgayBpbiB0aGlzLl9jYWNoZSkge1xuXHRcdFx0XHRpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMuX2NhY2hlLCBrKSkge1xuXHRcdFx0XHRcdGlmICh0aGlzLl9jYWNoZVtrXSAhPT0gdGhpcy5fZGF0YVtrXSkge1xuXHRcdFx0XHRcdFx0b1trXSA9IHRoaXMuX2RhdGFba107XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0XHRyZXR1cm4gbztcblx0XHR9XG5cblx0XHRmb3IgKGNvbnN0IGsgaW4gdGhpcy5fZGF0YSkge1xuXHRcdFx0aWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLl9kYXRhLCBrKSkge1xuXHRcdFx0XHRvW2tdID0gdGhpcy5fZGF0YVtrXTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gbztcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHNvbWUgY29sdW1uIHZhbHVlc1xuXHQgKi9cblx0dG9PYmplY3RTb21lKGNvbHVtbnM6IHN0cmluZ1tdKTogR29ibEVudGl0eURhdGEge1xuXHRcdGNvbnN0IG86IGFueSA9IHt9LFxuXHRcdFx0bGVuID0gY29sdW1ucy5sZW5ndGg7XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7XG5cdFx0XHRjb25zdCBjb2wgPSBjb2x1bW5zW2ldO1xuXHRcdFx0aWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLl9kYXRhLCBjb2wpKSB7XG5cdFx0XHRcdG9bY29sXSA9IHRoaXMuX2RhdGFbY29sXTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHRocm93IG5ldyBFcnJvcihgQ29sdW1uIFwiJHtjb2x9XCIgaXMgbm90IGRlZmluZWQgaW4gXCIke3RoaXMuX25hbWV9XCIuYCk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIG87XG5cdH1cblxuXHQvKipcblx0ICogSlNPTiBoZWxwZXJcblx0ICovXG5cdHRvSlNPTigpOiBhbnkge1xuXHRcdGNvbnN0IGRhdGEgPSB0aGlzLnRvT2JqZWN0KCk7XG5cdFx0ZGF0YVtnb2JsTWFya2VyXSA9IHRoaXMuX25hbWU7XG5cblx0XHRyZXR1cm4gZGF0YTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHRoZSBlbnRpdHkgY2FjaGUga2V5LlxuXHQgKlxuXHQgKiBgbnVsbGAgaXMgcmV0dXJuZWQgd2hlbiB3ZSBjYW4ndCBoYXZlIGEgdmFsaWQgY2FjaGUga2V5LlxuXHQgKi9cblx0Y2FjaGVLZXkoKTogc3RyaW5nIHwgbnVsbCB7XG5cdFx0Y29uc3QgY29sdW1ucyA9IHRoaXMuaWRlbnRpZmllckNvbHVtbnMoKS5zb3J0KCksXG5cdFx0XHRsZW4gPSBjb2x1bW5zLmxlbmd0aDtcblx0XHRsZXQgdmFsdWUgPSAnJyxcblx0XHRcdGkgPSAwO1xuXG5cdFx0aWYgKGxlbiA9PT0gMSkge1xuXHRcdFx0dmFsdWUgPSB0aGlzLl9kYXRhW2NvbHVtbnNbMF1dO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRmb3IgKDsgaSA8IGxlbjsgaSsrKSB7XG5cdFx0XHRcdGNvbnN0IHYgPSB0aGlzLl9kYXRhW2NvbHVtbnNbaV1dO1xuXHRcdFx0XHRpZiAodiAhPSBudWxsKSB7XG5cdFx0XHRcdFx0dmFsdWUgKz0gJ3wnICsgdjtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiB2YWx1ZSB8fCBudWxsO1xuXHR9XG5cblx0LyoqXG5cdCAqIEZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5XG5cdCAqL1xuXHR0b0luc3RhbmNlKGRhdGE6IEdvYmxFbnRpdHlEYXRhLCBjYWNoZSA9IGZhbHNlKSB7XG5cdFx0cmV0dXJuIHRvSW5zdGFuY2U8dGhpcz4oZGF0YSwgY2FjaGUpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5XG5cdCAqL1xuXHRzdWJDYWNoZShlbnRpdHlOYW1lOiBzdHJpbmcpIHtcblx0XHRyZXR1cm4gZ2V0RW50aXR5Q2FjaGUoZW50aXR5TmFtZSk7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyB0aGUgcHJpbWFyeSBrZXlzIG9mIHRoZSBlbnRpdHkuXG5cdCAqL1xuXHRhYnN0cmFjdCBpZGVudGlmaWVyQ29sdW1ucygpOiBzdHJpbmdbXTtcbn1cbiJdfQ==