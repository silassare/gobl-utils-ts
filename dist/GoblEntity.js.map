{"version":3,"file":"GoblEntity.js","sourceRoot":"","sources":["../src/GoblEntity.ts"],"names":[],"mappings":"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","sourcesContent":["import { goblMarker } from './gobl';\n\nexport type tGoblEntityData = {\n\t[key: string]: any;\n};\n\nconst ACTION_UNKNOWN = 0,\n\tACTION_SAVING = 1,\n\tACTION_DELETING = 2,\n\tACTION_UPDATING = 3;\n\n/**\n * GoblEntity class.\n */\nexport default abstract class GoblEntity {\n\tprotected readonly _data: any = {};\n\tprotected _cache: any = {};\n\tprotected _action: number = ACTION_UNKNOWN;\n\n\tprotected constructor(\n\t\t_initialData: tGoblEntityData = {},\n\t\tprivate readonly _name: string,\n\t\tprivate readonly _prefix: string,\n\t\tprivate readonly _columns: string[],\n\t) {\n\t\tconst ctx = this,\n\t\t\t// we use null not undefined since JSON.stringify will ignore properties with undefined value\n\t\t\t_def: null = null;\n\n\t\t_columns.forEach(function (col) {\n\t\t\tctx._data[col] = ctx._cache[col] =\n\t\t\t\tcol in _initialData ? _initialData[col] : _def;\n\t\t});\n\t}\n\n\t/**\n\t * Magic setter.\n\t *\n\t * @param column\n\t * @param value\n\t */\n\tprotected _set(column: string, value: any): this {\n\t\tif (Object.prototype.hasOwnProperty.call(this._data, column)) {\n\t\t\tthis._data[column] = value;\n\t\t}\n\n\t\treturn this;\n\t}\n\n\t/**\n\t * Checks is the entity is clean.\n\t */\n\tisClean(): boolean {\n\t\treturn Object.keys(this.toObject(true)).length === 0;\n\t}\n\n\t/**\n\t * Checks if the entity is saved.\n\t *\n\t * @param set When true the entity will be considered as saved.\n\t */\n\tisSaved(set?: boolean): boolean {\n\t\tif (set) {\n\t\t\tthis._cache = this.toObject();\n\t\t\treturn true;\n\t\t}\n\n\t\treturn this.isClean();\n\t}\n\n\t/**\n\t * Checks if the entity is being saved.\n\t *\n\t * @param set When true the state will be set to saving.\n\t */\n\tisSaving(set?: boolean): boolean {\n\t\tif (arguments.length) {\n\t\t\tthis._action = set ? ACTION_SAVING : ACTION_UNKNOWN;\n\t\t}\n\n\t\treturn this._action === ACTION_SAVING;\n\t}\n\n\t/**\n\t * Checks if the entity is being deleted.\n\t *\n\t * @param set When true the state will be set to deleting.\n\t */\n\tisDeleting(set?: boolean): boolean {\n\t\tif (arguments.length) {\n\t\t\tthis._action = set ? ACTION_DELETING : ACTION_UNKNOWN;\n\t\t}\n\n\t\treturn this._action === ACTION_DELETING;\n\t}\n\n\t/**\n\t * Checks if the entity is being updated.\n\t *\n\t * @param set When true the state will be set to updating.\n\t */\n\tisUpdating(set?: boolean): boolean {\n\t\tif (arguments.length) {\n\t\t\tthis._action = set ? ACTION_UPDATING : ACTION_UNKNOWN;\n\t\t}\n\n\t\treturn this._action === ACTION_UPDATING;\n\t}\n\n\t/**\n\t * Hydrate the entity and set as saved when `save` is true\n\t */\n\tdoHydrate(data: tGoblEntityData, save: boolean = false): this {\n\t\tconst ctx = this,\n\t\t\tsourceOfTruth = this._data;\n\n\t\tObject.keys(data).forEach(function (k) {\n\t\t\tif (Object.prototype.hasOwnProperty.call(sourceOfTruth, k)) {\n\t\t\t\t(ctx as any)[k.slice(ctx._prefix.length + 1)] = data[k];\n\t\t\t}\n\t\t});\n\n\t\tif (save) {\n\t\t\tthis.isSaved(true);\n\t\t}\n\n\t\treturn this;\n\t}\n\n\t/**\n\t * Returns current data in a clean new object\n\t *\n\t * if `diff` is true, returns modified columns only\n\t */\n\ttoObject(diff: boolean = false): tGoblEntityData {\n\t\tconst o: any = {};\n\n\t\tif (diff) {\n\t\t\tfor (const k in this._cache) {\n\t\t\t\tif (Object.prototype.hasOwnProperty.call(this._cache, k)) {\n\t\t\t\t\tif (this._cache[k] !== this._data[k]) {\n\t\t\t\t\t\to[k] = this._data[k];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn o;\n\t\t}\n\n\t\tfor (const k in this._data) {\n\t\t\tif (Object.prototype.hasOwnProperty.call(this._data, k)) {\n\t\t\t\to[k] = this._data[k];\n\t\t\t}\n\t\t}\n\n\t\treturn o;\n\t}\n\n\t/**\n\t * Returns some column values\n\t */\n\ttoObjectSome(columns: string[]): tGoblEntityData {\n\t\tconst o: any = {},\n\t\t\tlen = columns.length;\n\n\t\tfor (let i = 0; i < len; i++) {\n\t\t\tconst col = columns[i];\n\t\t\tif (Object.prototype.hasOwnProperty.call(this._data, col)) {\n\t\t\t\to[col] = this._data[col];\n\t\t\t} else {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t`Column \"${col}\" is not defined in \"${this._name}\".`,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\treturn o;\n\t}\n\n\t/**\n\t * JSON helper\n\t */\n\ttoJSON(): any {\n\t\tconst data = this.toObject();\n\t\tdata[goblMarker] = this._name;\n\n\t\treturn data;\n\t}\n\n\t/**\n\t * Returns the entity cache key.\n\t *\n\t * `null` is returned when we can't have a valid cache key.\n\t */\n\tcacheKey(): string | null {\n\t\tconst columns = this.identifierColumns().sort(),\n\t\t\tlen = columns.length;\n\t\tlet value = '',\n\t\t\ti = 0;\n\n\t\tif (len === 1) {\n\t\t\tvalue = this._data[columns[0]];\n\t\t} else {\n\t\t\tfor (; i < len; i++) {\n\t\t\t\tconst v = this._data[columns[i]];\n\t\t\t\tif (v != null) {\n\t\t\t\t\tvalue += v;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn value || null;\n\t}\n\n\t/**\n\t * Returns the primary keys of the entity.\n\t */\n\tabstract identifierColumns(): string[];\n}\n"]}