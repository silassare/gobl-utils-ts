"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const gobl_js_1 = require("./gobl.js");
var GoblEntityState;
(function (GoblEntityState) {
    GoblEntityState[GoblEntityState["UNKNOWN"] = 0] = "UNKNOWN";
    GoblEntityState[GoblEntityState["SAVING"] = 1] = "SAVING";
    GoblEntityState[GoblEntityState["DELETING"] = 2] = "DELETING";
    GoblEntityState[GoblEntityState["UPDATING"] = 3] = "UPDATING";
})(GoblEntityState || (GoblEntityState = {}));
/**
 * GoblEntity class.
 */
class GoblEntity {
    _name;
    _prefix;
    _columns;
    _data = {};
    _cache = {};
    _state = GoblEntityState.UNKNOWN;
    constructor(_initialData = {}, _name, _prefix, _columns) {
        this._name = _name;
        this._prefix = _prefix;
        this._columns = _columns;
        const ctx = this, 
        // we use null not undefined since JSON.stringify will ignore properties with undefined value
        _def = null;
        this._columns.forEach(function (col) {
            ctx._data[col] = ctx._cache[col] =
                col in _initialData ? _initialData[col] : _def;
        });
    }
    /**
     * Magic setter.
     *
     * @param column
     * @param value
     */
    _set(column, value) {
        if (Object.prototype.hasOwnProperty.call(this._data, column)) {
            this._data[column] = value;
        }
        return this;
    }
    /**
     * Checks if the entity is clean.
     */
    isClean() {
        return Object.keys(this.toObject(true)).length === 0;
    }
    /**
     * Checks if the entity is saved.
     *
     * @param set When true the entity will be considered as saved.
     */
    isSaved(set) {
        if (set) {
            this._cache = this.toObject();
            return true;
        }
        return this.isClean();
    }
    /**
     * Checks if the entity is being saved.
     *
     * @param set When true the state will be set to saving.
     */
    isSaving(set) {
        if (arguments.length) {
            this._state = set ? GoblEntityState.SAVING : GoblEntityState.UNKNOWN;
        }
        return this._state === GoblEntityState.SAVING;
    }
    /**
     * Checks if the entity is being deleted.
     *
     * @param set When true the state will be set to deleting.
     */
    isDeleting(set) {
        if (arguments.length) {
            this._state = set ? GoblEntityState.DELETING : GoblEntityState.UNKNOWN;
        }
        return this._state === GoblEntityState.DELETING;
    }
    /**
     * Checks if the entity is being updated.
     *
     * @param set When true the state will be set to updating.
     */
    isUpdating(set) {
        if (arguments.length) {
            this._state = set ? GoblEntityState.UPDATING : GoblEntityState.UNKNOWN;
        }
        return this._state === GoblEntityState.UPDATING;
    }
    /**
     * Hydrate the entity and set as saved when `save` is true
     */
    doHydrate(data, save = false) {
        const ctx = this, sourceOfTruth = this._data;
        Object.keys(data).forEach(function (k) {
            if (Object.prototype.hasOwnProperty.call(sourceOfTruth, k)) {
                ctx[k.slice(ctx._prefix.length + 1)] = data[k];
            }
        });
        if (save) {
            this.isSaved(true);
        }
        return this;
    }
    /**
     * Returns current data in a clean new object
     *
     * if `diff` is true, returns modified columns only
     */
    toObject(diff = false) {
        const o = {};
        const hasOwn = Object.prototype.hasOwnProperty;
        if (diff) {
            for (const prop in this._cache) {
                if (prop !== gobl_js_1.GOBL_ENTITY_MARKER &&
                    hasOwn.call(this._cache, prop) &&
                    this._cache[prop] !== this._data[prop]) {
                    o[prop] = this._data[prop];
                }
            }
            return o;
        }
        for (const prop in this._data) {
            if (hasOwn.call(this._data, prop)) {
                o[prop] = this._data[prop];
            }
        }
        // mark the object
        o[gobl_js_1.GOBL_ENTITY_MARKER] = this._name;
        return o;
    }
    /**
     * Returns some column values
     */
    toObjectSome(columns) {
        const o = {}, len = columns.length;
        for (let i = 0; i < len; i++) {
            const col = columns[i];
            if (Object.prototype.hasOwnProperty.call(this._data, col)) {
                o[col] = this._data[col];
            }
            else {
                throw new Error(`Column "${col}" is not defined in "${this._name}".`);
            }
        }
        return o;
    }
    /**
     * JSON helper
     */
    toJSON() {
        return this.toObject();
    }
    /**
     * Returns the entity cache key.
     *
     * `null` is returned when we can't have a valid cache key.
     */
    cacheKey() {
        const columns = this.identifierColumns().sort(), len = columns.length;
        let value = '', i = 0;
        if (len === 1) {
            value = this._data[columns[0]];
        }
        else {
            for (; i < len; i++) {
                const v = this._data[columns[i]];
                if (v != null) {
                    value += '|' + v;
                }
            }
        }
        return value || null;
    }
    /**
     * For backward compatibility
     */
    toInstance(data, cache = false) {
        return (0, gobl_js_1.toInstance)(data, cache);
    }
    /**
     * For backward compatibility
     */
    subCache(entityName) {
        return (0, gobl_js_1.getEntityCache)(entityName);
    }
}
exports.default = GoblEntity;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR29ibEVudGl0eS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Hb2JsRW50aXR5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsdUNBS21CO0FBRW5CLElBQUssZUFLSjtBQUxELFdBQUssZUFBZTtJQUNuQiwyREFBTyxDQUFBO0lBQ1AseURBQU0sQ0FBQTtJQUNOLDZEQUFRLENBQUE7SUFDUiw2REFBUSxDQUFBO0FBQ1QsQ0FBQyxFQUxJLGVBQWUsS0FBZixlQUFlLFFBS25CO0FBRUQ7O0dBRUc7QUFDSCxNQUE4QixVQUFVO0lBT3JCO0lBQ0E7SUFDQTtJQVJDLEtBQUssR0FBUSxFQUFFLENBQUM7SUFDekIsTUFBTSxHQUFRLEVBQUUsQ0FBQztJQUNqQixNQUFNLEdBQW9CLGVBQWUsQ0FBQyxPQUFPLENBQUM7SUFFNUQsWUFDQyxlQUErQixFQUFFLEVBQ2hCLEtBQWEsRUFDYixPQUFlLEVBQ2YsUUFBa0I7UUFGbEIsVUFBSyxHQUFMLEtBQUssQ0FBUTtRQUNiLFlBQU8sR0FBUCxPQUFPLENBQVE7UUFDZixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBRW5DLE1BQU0sR0FBRyxHQUFHLElBQUk7UUFDZiw2RkFBNkY7UUFDN0YsSUFBSSxHQUFHLElBQUksQ0FBQztRQUViLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLFVBQVUsR0FBRztZQUNsQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDO2dCQUMvQixHQUFHLElBQUksWUFBWSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUNqRCxDQUFDLENBQUMsQ0FBQztJQUNKLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNPLElBQUksQ0FBQyxNQUFjLEVBQUUsS0FBVTtRQUN4QyxJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLElB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SUFFRDs7T0FFRztJQUNILFVBQVUsQ0FBQyxJQUFvQixFQUFFLEtBQUssR0FBRyxLQUFLO1FBQzdDLE9BQU8sSUFBQSxvQkFBVSxFQUFPLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxRQUFRLENBQUMsVUFBa0I7UUFDMUIsT0FBTyxJQUFBLHdCQUFjLEVBQUMsVUFBVSxDQUFDLENBQUM7SUFDbkMsQ0FBQztDQU1EO0FBMU5ELDZCQTBOQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG5cdHR5cGUgR29ibEVudGl0eURhdGEsXG5cdGdldEVudGl0eUNhY2hlLFxuXHRHT0JMX0VOVElUWV9NQVJLRVIsXG5cdHRvSW5zdGFuY2UsXG59IGZyb20gJy4vZ29ibC5qcyc7XG5cbmVudW0gR29ibEVudGl0eVN0YXRlIHtcblx0VU5LTk9XTixcblx0U0FWSU5HLFxuXHRERUxFVElORyxcblx0VVBEQVRJTkcsXG59XG5cbi8qKlxuICogR29ibEVudGl0eSBjbGFzcy5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgYWJzdHJhY3QgY2xhc3MgR29ibEVudGl0eSB7XG5cdHByb3RlY3RlZCByZWFkb25seSBfZGF0YTogYW55ID0ge307XG5cdHByb3RlY3RlZCBfY2FjaGU6IGFueSA9IHt9O1xuXHRwcm90ZWN0ZWQgX3N0YXRlOiBHb2JsRW50aXR5U3RhdGUgPSBHb2JsRW50aXR5U3RhdGUuVU5LTk9XTjtcblxuXHRwcm90ZWN0ZWQgY29uc3RydWN0b3IoXG5cdFx0X2luaXRpYWxEYXRhOiBHb2JsRW50aXR5RGF0YSA9IHt9LFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgX25hbWU6IHN0cmluZyxcblx0XHRwcml2YXRlIHJlYWRvbmx5IF9wcmVmaXg6IHN0cmluZyxcblx0XHRwcml2YXRlIHJlYWRvbmx5IF9jb2x1bW5zOiBzdHJpbmdbXVxuXHQpIHtcblx0XHRjb25zdCBjdHggPSB0aGlzLFxuXHRcdFx0Ly8gd2UgdXNlIG51bGwgbm90IHVuZGVmaW5lZCBzaW5jZSBKU09OLnN0cmluZ2lmeSB3aWxsIGlnbm9yZSBwcm9wZXJ0aWVzIHdpdGggdW5kZWZpbmVkIHZhbHVlXG5cdFx0XHRfZGVmID0gbnVsbDtcblxuXHRcdHRoaXMuX2NvbHVtbnMuZm9yRWFjaChmdW5jdGlvbiAoY29sKSB7XG5cdFx0XHRjdHguX2RhdGFbY29sXSA9IGN0eC5fY2FjaGVbY29sXSA9XG5cdFx0XHRcdGNvbCBpbiBfaW5pdGlhbERhdGEgPyBfaW5pdGlhbERhdGFbY29sXSA6IF9kZWY7XG5cdFx0fSk7XG5cdH1cblxuXHQvKipcblx0ICogTWFnaWMgc2V0dGVyLlxuXHQgKlxuXHQgKiBAcGFyYW0gY29sdW1uXG5cdCAqIEBwYXJhbSB2YWx1ZVxuXHQgKi9cblx0cHJvdGVjdGVkIF9zZXQoY29sdW1uOiBzdHJpbmcsIHZhbHVlOiBhbnkpOiB0aGlzIHtcblx0XHRpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMuX2RhdGEsIGNvbHVtbikpIHtcblx0XHRcdHRoaXMuX2RhdGFbY29sdW1uXSA9IHZhbHVlO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0LyoqXG5cdCAqIENoZWNrcyBpZiB0aGUgZW50aXR5IGlzIGNsZWFuLlxuXHQgKi9cblx0aXNDbGVhbigpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gT2JqZWN0LmtleXModGhpcy50b09iamVjdCh0cnVlKSkubGVuZ3RoID09PSAwO1xuXHR9XG5cblx0LyoqXG5cdCAqIENoZWNrcyBpZiB0aGUgZW50aXR5IGlzIHNhdmVkLlxuXHQgKlxuXHQgKiBAcGFyYW0gc2V0IFdoZW4gdHJ1ZSB0aGUgZW50aXR5IHdpbGwgYmUgY29uc2lkZXJlZCBhcyBzYXZlZC5cblx0ICovXG5cdGlzU2F2ZWQoc2V0PzogYm9vbGVhbik6IGJvb2xlYW4ge1xuXHRcdGlmIChzZXQpIHtcblx0XHRcdHRoaXMuX2NhY2hlID0gdGhpcy50b09iamVjdCgpO1xuXHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuaXNDbGVhbigpO1xuXHR9XG5cblx0LyoqXG5cdCAqIENoZWNrcyBpZiB0aGUgZW50aXR5IGlzIGJlaW5nIHNhdmVkLlxuXHQgKlxuXHQgKiBAcGFyYW0gc2V0IFdoZW4gdHJ1ZSB0aGUgc3RhdGUgd2lsbCBiZSBzZXQgdG8gc2F2aW5nLlxuXHQgKi9cblx0aXNTYXZpbmcoc2V0PzogYm9vbGVhbik6IGJvb2xlYW4ge1xuXHRcdGlmIChhcmd1bWVudHMubGVuZ3RoKSB7XG5cdFx0XHR0aGlzLl9zdGF0ZSA9IHNldCA/IEdvYmxFbnRpdHlTdGF0ZS5TQVZJTkcgOiBHb2JsRW50aXR5U3RhdGUuVU5LTk9XTjtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5fc3RhdGUgPT09IEdvYmxFbnRpdHlTdGF0ZS5TQVZJTkc7XG5cdH1cblxuXHQvKipcblx0ICogQ2hlY2tzIGlmIHRoZSBlbnRpdHkgaXMgYmVpbmcgZGVsZXRlZC5cblx0ICpcblx0ICogQHBhcmFtIHNldCBXaGVuIHRydWUgdGhlIHN0YXRlIHdpbGwgYmUgc2V0IHRvIGRlbGV0aW5nLlxuXHQgKi9cblx0aXNEZWxldGluZyhzZXQ/OiBib29sZWFuKTogYm9vbGVhbiB7XG5cdFx0aWYgKGFyZ3VtZW50cy5sZW5ndGgpIHtcblx0XHRcdHRoaXMuX3N0YXRlID0gc2V0ID8gR29ibEVudGl0eVN0YXRlLkRFTEVUSU5HIDogR29ibEVudGl0eVN0YXRlLlVOS05PV047XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuX3N0YXRlID09PSBHb2JsRW50aXR5U3RhdGUuREVMRVRJTkc7XG5cdH1cblxuXHQvKipcblx0ICogQ2hlY2tzIGlmIHRoZSBlbnRpdHkgaXMgYmVpbmcgdXBkYXRlZC5cblx0ICpcblx0ICogQHBhcmFtIHNldCBXaGVuIHRydWUgdGhlIHN0YXRlIHdpbGwgYmUgc2V0IHRvIHVwZGF0aW5nLlxuXHQgKi9cblx0aXNVcGRhdGluZyhzZXQ/OiBib29sZWFuKTogYm9vbGVhbiB7XG5cdFx0aWYgKGFyZ3VtZW50cy5sZW5ndGgpIHtcblx0XHRcdHRoaXMuX3N0YXRlID0gc2V0ID8gR29ibEVudGl0eVN0YXRlLlVQREFUSU5HIDogR29ibEVudGl0eVN0YXRlLlVOS05PV047XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuX3N0YXRlID09PSBHb2JsRW50aXR5U3RhdGUuVVBEQVRJTkc7XG5cdH1cblxuXHQvKipcblx0ICogSHlkcmF0ZSB0aGUgZW50aXR5IGFuZCBzZXQgYXMgc2F2ZWQgd2hlbiBgc2F2ZWAgaXMgdHJ1ZVxuXHQgKi9cblx0ZG9IeWRyYXRlKGRhdGE6IEdvYmxFbnRpdHlEYXRhLCBzYXZlID0gZmFsc2UpOiB0aGlzIHtcblx0XHRjb25zdCBjdHggPSB0aGlzLFxuXHRcdFx0c291cmNlT2ZUcnV0aCA9IHRoaXMuX2RhdGE7XG5cblx0XHRPYmplY3Qua2V5cyhkYXRhKS5mb3JFYWNoKGZ1bmN0aW9uIChrKSB7XG5cdFx0XHRpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHNvdXJjZU9mVHJ1dGgsIGspKSB7XG5cdFx0XHRcdChjdHggYXMgYW55KVtrLnNsaWNlKGN0eC5fcHJlZml4Lmxlbmd0aCArIDEpXSA9IGRhdGFba107XG5cdFx0XHR9XG5cdFx0fSk7XG5cblx0XHRpZiAoc2F2ZSkge1xuXHRcdFx0dGhpcy5pc1NhdmVkKHRydWUpO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgY3VycmVudCBkYXRhIGluIGEgY2xlYW4gbmV3IG9iamVjdFxuXHQgKlxuXHQgKiBpZiBgZGlmZmAgaXMgdHJ1ZSwgcmV0dXJucyBtb2RpZmllZCBjb2x1bW5zIG9ubHlcblx0ICovXG5cdHRvT2JqZWN0KGRpZmYgPSBmYWxzZSk6IEdvYmxFbnRpdHlEYXRhIHtcblx0XHRjb25zdCBvOiBHb2JsRW50aXR5RGF0YSA9IHt9O1xuXHRcdGNvbnN0IGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7XG5cblx0XHRpZiAoZGlmZikge1xuXHRcdFx0Zm9yIChjb25zdCBwcm9wIGluIHRoaXMuX2NhY2hlKSB7XG5cdFx0XHRcdGlmIChcblx0XHRcdFx0XHRwcm9wICE9PSBHT0JMX0VOVElUWV9NQVJLRVIgJiZcblx0XHRcdFx0XHRoYXNPd24uY2FsbCh0aGlzLl9jYWNoZSwgcHJvcCkgJiZcblx0XHRcdFx0XHR0aGlzLl9jYWNoZVtwcm9wXSAhPT0gdGhpcy5fZGF0YVtwcm9wXVxuXHRcdFx0XHQpIHtcblx0XHRcdFx0XHRvW3Byb3BdID0gdGhpcy5fZGF0YVtwcm9wXTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdFx0cmV0dXJuIG87XG5cdFx0fVxuXG5cdFx0Zm9yIChjb25zdCBwcm9wIGluIHRoaXMuX2RhdGEpIHtcblx0XHRcdGlmIChoYXNPd24uY2FsbCh0aGlzLl9kYXRhLCBwcm9wKSkge1xuXHRcdFx0XHRvW3Byb3BdID0gdGhpcy5fZGF0YVtwcm9wXTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHQvLyBtYXJrIHRoZSBvYmplY3Rcblx0XHRvW0dPQkxfRU5USVRZX01BUktFUl0gPSB0aGlzLl9uYW1lO1xuXG5cdFx0cmV0dXJuIG87XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyBzb21lIGNvbHVtbiB2YWx1ZXNcblx0ICovXG5cdHRvT2JqZWN0U29tZShjb2x1bW5zOiBzdHJpbmdbXSk6IEdvYmxFbnRpdHlEYXRhIHtcblx0XHRjb25zdCBvOiBhbnkgPSB7fSxcblx0XHRcdGxlbiA9IGNvbHVtbnMubGVuZ3RoO1xuXG5cdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykge1xuXHRcdFx0Y29uc3QgY29sID0gY29sdW1uc1tpXTtcblx0XHRcdGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGhpcy5fZGF0YSwgY29sKSkge1xuXHRcdFx0XHRvW2NvbF0gPSB0aGlzLl9kYXRhW2NvbF07XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoYENvbHVtbiBcIiR7Y29sfVwiIGlzIG5vdCBkZWZpbmVkIGluIFwiJHt0aGlzLl9uYW1lfVwiLmApO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiBvO1xuXHR9XG5cblx0LyoqXG5cdCAqIEpTT04gaGVscGVyXG5cdCAqL1xuXHR0b0pTT04oKTogYW55IHtcblx0XHRyZXR1cm4gdGhpcy50b09iamVjdCgpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgdGhlIGVudGl0eSBjYWNoZSBrZXkuXG5cdCAqXG5cdCAqIGBudWxsYCBpcyByZXR1cm5lZCB3aGVuIHdlIGNhbid0IGhhdmUgYSB2YWxpZCBjYWNoZSBrZXkuXG5cdCAqL1xuXHRjYWNoZUtleSgpOiBzdHJpbmcgfCBudWxsIHtcblx0XHRjb25zdCBjb2x1bW5zID0gdGhpcy5pZGVudGlmaWVyQ29sdW1ucygpLnNvcnQoKSxcblx0XHRcdGxlbiA9IGNvbHVtbnMubGVuZ3RoO1xuXHRcdGxldCB2YWx1ZSA9ICcnLFxuXHRcdFx0aSA9IDA7XG5cblx0XHRpZiAobGVuID09PSAxKSB7XG5cdFx0XHR2YWx1ZSA9IHRoaXMuX2RhdGFbY29sdW1uc1swXV07XG5cdFx0fSBlbHNlIHtcblx0XHRcdGZvciAoOyBpIDwgbGVuOyBpKyspIHtcblx0XHRcdFx0Y29uc3QgdiA9IHRoaXMuX2RhdGFbY29sdW1uc1tpXV07XG5cdFx0XHRcdGlmICh2ICE9IG51bGwpIHtcblx0XHRcdFx0XHR2YWx1ZSArPSAnfCcgKyB2O1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHZhbHVlIHx8IG51bGw7XG5cdH1cblxuXHQvKipcblx0ICogRm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHlcblx0ICovXG5cdHRvSW5zdGFuY2UoZGF0YTogR29ibEVudGl0eURhdGEsIGNhY2hlID0gZmFsc2UpIHtcblx0XHRyZXR1cm4gdG9JbnN0YW5jZTx0aGlzPihkYXRhLCBjYWNoZSk7XG5cdH1cblxuXHQvKipcblx0ICogRm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHlcblx0ICovXG5cdHN1YkNhY2hlKGVudGl0eU5hbWU6IHN0cmluZykge1xuXHRcdHJldHVybiBnZXRFbnRpdHlDYWNoZShlbnRpdHlOYW1lKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHRoZSBwcmltYXJ5IGtleXMgb2YgdGhlIGVudGl0eS5cblx0ICovXG5cdGFic3RyYWN0IGlkZW50aWZpZXJDb2x1bW5zKCk6IHN0cmluZ1tdO1xufVxuIl19