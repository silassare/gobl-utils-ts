"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const gobl_js_1 = require("./gobl.js");
var GoblEntityState;
(function (GoblEntityState) {
    GoblEntityState[GoblEntityState["UNKNOWN"] = 0] = "UNKNOWN";
    GoblEntityState[GoblEntityState["SAVING"] = 1] = "SAVING";
    GoblEntityState[GoblEntityState["DELETING"] = 2] = "DELETING";
    GoblEntityState[GoblEntityState["UPDATING"] = 3] = "UPDATING";
})(GoblEntityState || (GoblEntityState = {}));
/**
 * GoblEntity class.
 */
class GoblEntity {
    _name;
    _prefix;
    _columns;
    _data = {};
    _cache = {};
    _state = GoblEntityState.UNKNOWN;
    constructor(_initialData = {}, _name, _prefix, _columns) {
        this._name = _name;
        this._prefix = _prefix;
        this._columns = _columns;
        const ctx = this, 
        // we use null not undefined since JSON.stringify will ignore properties with undefined value
        _def = null;
        this._columns.forEach(function (col) {
            ctx._data[col] = ctx._cache[col] =
                col in _initialData ? _initialData[col] : _def;
        });
    }
    /**
     * Magic setter.
     *
     * @param column
     * @param value
     */
    _set(column, value) {
        if (Object.prototype.hasOwnProperty.call(this._data, column)) {
            this._data[column] = value;
        }
        return this;
    }
    /**
     * Checks if the entity is clean.
     */
    isClean() {
        return Object.keys(this.toObject(true)).length === 0;
    }
    /**
     * Checks if the entity is saved.
     *
     * @param set When true the entity will be considered as saved.
     */
    isSaved(set) {
        if (set) {
            this._cache = this.toObject();
            return true;
        }
        return this.isClean();
    }
    /**
     * Checks if the entity is being saved.
     *
     * @param set When true the state will be set to saving.
     */
    isSaving(set) {
        if (arguments.length) {
            this._state = set ? GoblEntityState.SAVING : GoblEntityState.UNKNOWN;
        }
        return this._state === GoblEntityState.SAVING;
    }
    /**
     * Checks if the entity is being deleted.
     *
     * @param set When true the state will be set to deleting.
     */
    isDeleting(set) {
        if (arguments.length) {
            this._state = set ? GoblEntityState.DELETING : GoblEntityState.UNKNOWN;
        }
        return this._state === GoblEntityState.DELETING;
    }
    /**
     * Checks if the entity is being updated.
     *
     * @param set When true the state will be set to updating.
     */
    isUpdating(set) {
        if (arguments.length) {
            this._state = set ? GoblEntityState.UPDATING : GoblEntityState.UNKNOWN;
        }
        return this._state === GoblEntityState.UPDATING;
    }
    /**
     * Hydrate the entity and set as saved when `save` is true
     */
    doHydrate(data, save = false) {
        const ctx = this, sourceOfTruth = this._data;
        Object.keys(data).forEach(function (k) {
            if (Object.prototype.hasOwnProperty.call(sourceOfTruth, k)) {
                ctx[k.slice(ctx._prefix.length + 1)] = data[k];
            }
        });
        if (save) {
            this.isSaved(true);
        }
        return this;
    }
    /**
     * Returns current data in a clean new object
     *
     * if `diff` is true, returns modified columns only
     */
    toObject(diff = false) {
        const o = {};
        const hasOwn = Object.prototype.hasOwnProperty;
        if (diff) {
            for (const prop in this._cache) {
                if (prop !== gobl_js_1.GOBL_ENTITY_MARKER &&
                    hasOwn.call(this._cache, prop) &&
                    this._cache[prop] !== this._data[prop]) {
                    o[prop] = this._data[prop];
                }
            }
            return o;
        }
        for (const prop in this._data) {
            if (hasOwn.call(this._data, prop)) {
                o[prop] = this._data[prop];
            }
        }
        // mark the object
        o[gobl_js_1.GOBL_ENTITY_MARKER] = this._name;
        return o;
    }
    /**
     * Returns some column values
     */
    toObjectSome(columns) {
        const o = {}, len = columns.length;
        for (let i = 0; i < len; i++) {
            const col = columns[i];
            if (Object.prototype.hasOwnProperty.call(this._data, col)) {
                o[col] = this._data[col];
            }
            else {
                throw new Error(`Column "${col}" is not defined in "${this._name}".`);
            }
        }
        return o;
    }
    /**
     * JSON helper
     */
    toJSON() {
        return this.toObject();
    }
    /**
     * Returns the entity cache key.
     *
     * `null` is returned when we can't have a valid cache key.
     */
    cacheKey() {
        const columns = this.identifierColumns().sort(), len = columns.length;
        let value = '', i = 0;
        if (len === 1) {
            value = this._data[columns[0]];
        }
        else {
            for (; i < len; i++) {
                const v = this._data[columns[i]];
                if (v != null) {
                    value += '|' + v;
                }
            }
        }
        return value || null;
    }
    /**
     * For backward compatibility
     */
    toInstance(data, cache = false) {
        return (0, gobl_js_1.toInstance)(data, cache);
    }
}
exports.default = GoblEntity;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR29ibEVudGl0eS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Hb2JsRW50aXR5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsdUNBQWdGO0FBRWhGLElBQUssZUFLSjtBQUxELFdBQUssZUFBZTtJQUNuQiwyREFBTyxDQUFBO0lBQ1AseURBQU0sQ0FBQTtJQUNOLDZEQUFRLENBQUE7SUFDUiw2REFBUSxDQUFBO0FBQ1QsQ0FBQyxFQUxJLGVBQWUsS0FBZixlQUFlLFFBS25CO0FBRUQ7O0dBRUc7QUFDSCxNQUE4QixVQUFVO0lBT3JCO0lBQ0E7SUFDQTtJQVJDLEtBQUssR0FBUSxFQUFFLENBQUM7SUFDekIsTUFBTSxHQUFRLEVBQUUsQ0FBQztJQUNqQixNQUFNLEdBQW9CLGVBQWUsQ0FBQyxPQUFPLENBQUM7SUFFNUQsWUFDQyxlQUErQixFQUFFLEVBQ2hCLEtBQWEsRUFDYixPQUFlLEVBQ2YsUUFBa0I7UUFGbEIsVUFBSyxHQUFMLEtBQUssQ0FBUTtRQUNiLFlBQU8sR0FBUCxPQUFPLENBQVE7UUFDZixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBRW5DLE1BQU0sR0FBRyxHQUFHLElBQUk7UUFDZiw2RkFBNkY7UUFDN0YsSUFBSSxHQUFHLElBQUksQ0FBQztRQUViLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLFVBQVUsR0FBRztZQUNsQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDO2dCQUMvQixHQUFHLElBQUksWUFBWSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUNqRCxDQUFDLENBQUMsQ0FBQztJQUNKLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNPLElBQUksQ0FBQyxNQUFjLEVBQUUsS0FBVTtRQUN4QyxJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLElB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SUFFRDs7T0FFRztJQUNILFVBQVUsQ0FBQyxJQUFvQixFQUFFLEtBQUssR0FBRyxLQUFLO1FBQzdDLE9BQU8sSUFBQSxvQkFBVSxFQUFPLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztJQUN0QyxDQUFDO0NBTUQ7QUFuTkQsNkJBbU5DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgdHlwZSBHb2JsRW50aXR5RGF0YSwgR09CTF9FTlRJVFlfTUFSS0VSLCB0b0luc3RhbmNlIH0gZnJvbSAnLi9nb2JsLmpzJztcblxuZW51bSBHb2JsRW50aXR5U3RhdGUge1xuXHRVTktOT1dOLFxuXHRTQVZJTkcsXG5cdERFTEVUSU5HLFxuXHRVUERBVElORyxcbn1cblxuLyoqXG4gKiBHb2JsRW50aXR5IGNsYXNzLlxuICovXG5leHBvcnQgZGVmYXVsdCBhYnN0cmFjdCBjbGFzcyBHb2JsRW50aXR5IHtcblx0cHJvdGVjdGVkIHJlYWRvbmx5IF9kYXRhOiBhbnkgPSB7fTtcblx0cHJvdGVjdGVkIF9jYWNoZTogYW55ID0ge307XG5cdHByb3RlY3RlZCBfc3RhdGU6IEdvYmxFbnRpdHlTdGF0ZSA9IEdvYmxFbnRpdHlTdGF0ZS5VTktOT1dOO1xuXG5cdHByb3RlY3RlZCBjb25zdHJ1Y3Rvcihcblx0XHRfaW5pdGlhbERhdGE6IEdvYmxFbnRpdHlEYXRhID0ge30sXG5cdFx0cHJpdmF0ZSByZWFkb25seSBfbmFtZTogc3RyaW5nLFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgX3ByZWZpeDogc3RyaW5nLFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgX2NvbHVtbnM6IHN0cmluZ1tdXG5cdCkge1xuXHRcdGNvbnN0IGN0eCA9IHRoaXMsXG5cdFx0XHQvLyB3ZSB1c2UgbnVsbCBub3QgdW5kZWZpbmVkIHNpbmNlIEpTT04uc3RyaW5naWZ5IHdpbGwgaWdub3JlIHByb3BlcnRpZXMgd2l0aCB1bmRlZmluZWQgdmFsdWVcblx0XHRcdF9kZWYgPSBudWxsO1xuXG5cdFx0dGhpcy5fY29sdW1ucy5mb3JFYWNoKGZ1bmN0aW9uIChjb2wpIHtcblx0XHRcdGN0eC5fZGF0YVtjb2xdID0gY3R4Ll9jYWNoZVtjb2xdID1cblx0XHRcdFx0Y29sIGluIF9pbml0aWFsRGF0YSA/IF9pbml0aWFsRGF0YVtjb2xdIDogX2RlZjtcblx0XHR9KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBNYWdpYyBzZXR0ZXIuXG5cdCAqXG5cdCAqIEBwYXJhbSBjb2x1bW5cblx0ICogQHBhcmFtIHZhbHVlXG5cdCAqL1xuXHRwcm90ZWN0ZWQgX3NldChjb2x1bW46IHN0cmluZywgdmFsdWU6IGFueSk6IHRoaXMge1xuXHRcdGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGhpcy5fZGF0YSwgY29sdW1uKSkge1xuXHRcdFx0dGhpcy5fZGF0YVtjb2x1bW5dID0gdmFsdWU7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQvKipcblx0ICogQ2hlY2tzIGlmIHRoZSBlbnRpdHkgaXMgY2xlYW4uXG5cdCAqL1xuXHRpc0NsZWFuKCk6IGJvb2xlYW4ge1xuXHRcdHJldHVybiBPYmplY3Qua2V5cyh0aGlzLnRvT2JqZWN0KHRydWUpKS5sZW5ndGggPT09IDA7XG5cdH1cblxuXHQvKipcblx0ICogQ2hlY2tzIGlmIHRoZSBlbnRpdHkgaXMgc2F2ZWQuXG5cdCAqXG5cdCAqIEBwYXJhbSBzZXQgV2hlbiB0cnVlIHRoZSBlbnRpdHkgd2lsbCBiZSBjb25zaWRlcmVkIGFzIHNhdmVkLlxuXHQgKi9cblx0aXNTYXZlZChzZXQ/OiBib29sZWFuKTogYm9vbGVhbiB7XG5cdFx0aWYgKHNldCkge1xuXHRcdFx0dGhpcy5fY2FjaGUgPSB0aGlzLnRvT2JqZWN0KCk7XG5cdFx0XHRyZXR1cm4gdHJ1ZTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5pc0NsZWFuKCk7XG5cdH1cblxuXHQvKipcblx0ICogQ2hlY2tzIGlmIHRoZSBlbnRpdHkgaXMgYmVpbmcgc2F2ZWQuXG5cdCAqXG5cdCAqIEBwYXJhbSBzZXQgV2hlbiB0cnVlIHRoZSBzdGF0ZSB3aWxsIGJlIHNldCB0byBzYXZpbmcuXG5cdCAqL1xuXHRpc1NhdmluZyhzZXQ/OiBib29sZWFuKTogYm9vbGVhbiB7XG5cdFx0aWYgKGFyZ3VtZW50cy5sZW5ndGgpIHtcblx0XHRcdHRoaXMuX3N0YXRlID0gc2V0ID8gR29ibEVudGl0eVN0YXRlLlNBVklORyA6IEdvYmxFbnRpdHlTdGF0ZS5VTktOT1dOO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzLl9zdGF0ZSA9PT0gR29ibEVudGl0eVN0YXRlLlNBVklORztcblx0fVxuXG5cdC8qKlxuXHQgKiBDaGVja3MgaWYgdGhlIGVudGl0eSBpcyBiZWluZyBkZWxldGVkLlxuXHQgKlxuXHQgKiBAcGFyYW0gc2V0IFdoZW4gdHJ1ZSB0aGUgc3RhdGUgd2lsbCBiZSBzZXQgdG8gZGVsZXRpbmcuXG5cdCAqL1xuXHRpc0RlbGV0aW5nKHNldD86IGJvb2xlYW4pOiBib29sZWFuIHtcblx0XHRpZiAoYXJndW1lbnRzLmxlbmd0aCkge1xuXHRcdFx0dGhpcy5fc3RhdGUgPSBzZXQgPyBHb2JsRW50aXR5U3RhdGUuREVMRVRJTkcgOiBHb2JsRW50aXR5U3RhdGUuVU5LTk9XTjtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5fc3RhdGUgPT09IEdvYmxFbnRpdHlTdGF0ZS5ERUxFVElORztcblx0fVxuXG5cdC8qKlxuXHQgKiBDaGVja3MgaWYgdGhlIGVudGl0eSBpcyBiZWluZyB1cGRhdGVkLlxuXHQgKlxuXHQgKiBAcGFyYW0gc2V0IFdoZW4gdHJ1ZSB0aGUgc3RhdGUgd2lsbCBiZSBzZXQgdG8gdXBkYXRpbmcuXG5cdCAqL1xuXHRpc1VwZGF0aW5nKHNldD86IGJvb2xlYW4pOiBib29sZWFuIHtcblx0XHRpZiAoYXJndW1lbnRzLmxlbmd0aCkge1xuXHRcdFx0dGhpcy5fc3RhdGUgPSBzZXQgPyBHb2JsRW50aXR5U3RhdGUuVVBEQVRJTkcgOiBHb2JsRW50aXR5U3RhdGUuVU5LTk9XTjtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5fc3RhdGUgPT09IEdvYmxFbnRpdHlTdGF0ZS5VUERBVElORztcblx0fVxuXG5cdC8qKlxuXHQgKiBIeWRyYXRlIHRoZSBlbnRpdHkgYW5kIHNldCBhcyBzYXZlZCB3aGVuIGBzYXZlYCBpcyB0cnVlXG5cdCAqL1xuXHRkb0h5ZHJhdGUoZGF0YTogR29ibEVudGl0eURhdGEsIHNhdmUgPSBmYWxzZSk6IHRoaXMge1xuXHRcdGNvbnN0IGN0eCA9IHRoaXMsXG5cdFx0XHRzb3VyY2VPZlRydXRoID0gdGhpcy5fZGF0YTtcblxuXHRcdE9iamVjdC5rZXlzKGRhdGEpLmZvckVhY2goZnVuY3Rpb24gKGspIHtcblx0XHRcdGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc291cmNlT2ZUcnV0aCwgaykpIHtcblx0XHRcdFx0KGN0eCBhcyBhbnkpW2suc2xpY2UoY3R4Ll9wcmVmaXgubGVuZ3RoICsgMSldID0gZGF0YVtrXTtcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdGlmIChzYXZlKSB7XG5cdFx0XHR0aGlzLmlzU2F2ZWQodHJ1ZSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyBjdXJyZW50IGRhdGEgaW4gYSBjbGVhbiBuZXcgb2JqZWN0XG5cdCAqXG5cdCAqIGlmIGBkaWZmYCBpcyB0cnVlLCByZXR1cm5zIG1vZGlmaWVkIGNvbHVtbnMgb25seVxuXHQgKi9cblx0dG9PYmplY3QoZGlmZiA9IGZhbHNlKTogR29ibEVudGl0eURhdGEge1xuXHRcdGNvbnN0IG86IEdvYmxFbnRpdHlEYXRhID0ge307XG5cdFx0Y29uc3QgaGFzT3duID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTtcblxuXHRcdGlmIChkaWZmKSB7XG5cdFx0XHRmb3IgKGNvbnN0IHByb3AgaW4gdGhpcy5fY2FjaGUpIHtcblx0XHRcdFx0aWYgKFxuXHRcdFx0XHRcdHByb3AgIT09IEdPQkxfRU5USVRZX01BUktFUiAmJlxuXHRcdFx0XHRcdGhhc093bi5jYWxsKHRoaXMuX2NhY2hlLCBwcm9wKSAmJlxuXHRcdFx0XHRcdHRoaXMuX2NhY2hlW3Byb3BdICE9PSB0aGlzLl9kYXRhW3Byb3BdXG5cdFx0XHRcdCkge1xuXHRcdFx0XHRcdG9bcHJvcF0gPSB0aGlzLl9kYXRhW3Byb3BdO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0XHRyZXR1cm4gbztcblx0XHR9XG5cblx0XHRmb3IgKGNvbnN0IHByb3AgaW4gdGhpcy5fZGF0YSkge1xuXHRcdFx0aWYgKGhhc093bi5jYWxsKHRoaXMuX2RhdGEsIHByb3ApKSB7XG5cdFx0XHRcdG9bcHJvcF0gPSB0aGlzLl9kYXRhW3Byb3BdO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdC8vIG1hcmsgdGhlIG9iamVjdFxuXHRcdG9bR09CTF9FTlRJVFlfTUFSS0VSXSA9IHRoaXMuX25hbWU7XG5cblx0XHRyZXR1cm4gbztcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHNvbWUgY29sdW1uIHZhbHVlc1xuXHQgKi9cblx0dG9PYmplY3RTb21lKGNvbHVtbnM6IHN0cmluZ1tdKTogR29ibEVudGl0eURhdGEge1xuXHRcdGNvbnN0IG86IGFueSA9IHt9LFxuXHRcdFx0bGVuID0gY29sdW1ucy5sZW5ndGg7XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7XG5cdFx0XHRjb25zdCBjb2wgPSBjb2x1bW5zW2ldO1xuXHRcdFx0aWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLl9kYXRhLCBjb2wpKSB7XG5cdFx0XHRcdG9bY29sXSA9IHRoaXMuX2RhdGFbY29sXTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHRocm93IG5ldyBFcnJvcihgQ29sdW1uIFwiJHtjb2x9XCIgaXMgbm90IGRlZmluZWQgaW4gXCIke3RoaXMuX25hbWV9XCIuYCk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIG87XG5cdH1cblxuXHQvKipcblx0ICogSlNPTiBoZWxwZXJcblx0ICovXG5cdHRvSlNPTigpOiBhbnkge1xuXHRcdHJldHVybiB0aGlzLnRvT2JqZWN0KCk7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyB0aGUgZW50aXR5IGNhY2hlIGtleS5cblx0ICpcblx0ICogYG51bGxgIGlzIHJldHVybmVkIHdoZW4gd2UgY2FuJ3QgaGF2ZSBhIHZhbGlkIGNhY2hlIGtleS5cblx0ICovXG5cdGNhY2hlS2V5KCk6IHN0cmluZyB8IG51bGwge1xuXHRcdGNvbnN0IGNvbHVtbnMgPSB0aGlzLmlkZW50aWZpZXJDb2x1bW5zKCkuc29ydCgpLFxuXHRcdFx0bGVuID0gY29sdW1ucy5sZW5ndGg7XG5cdFx0bGV0IHZhbHVlID0gJycsXG5cdFx0XHRpID0gMDtcblxuXHRcdGlmIChsZW4gPT09IDEpIHtcblx0XHRcdHZhbHVlID0gdGhpcy5fZGF0YVtjb2x1bW5zWzBdXTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Zm9yICg7IGkgPCBsZW47IGkrKykge1xuXHRcdFx0XHRjb25zdCB2ID0gdGhpcy5fZGF0YVtjb2x1bW5zW2ldXTtcblx0XHRcdFx0aWYgKHYgIT0gbnVsbCkge1xuXHRcdFx0XHRcdHZhbHVlICs9ICd8JyArIHY7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gdmFsdWUgfHwgbnVsbDtcblx0fVxuXG5cdC8qKlxuXHQgKiBGb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eVxuXHQgKi9cblx0dG9JbnN0YW5jZShkYXRhOiBHb2JsRW50aXR5RGF0YSwgY2FjaGUgPSBmYWxzZSkge1xuXHRcdHJldHVybiB0b0luc3RhbmNlPHRoaXM+KGRhdGEsIGNhY2hlKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHRoZSBwcmltYXJ5IGtleXMgb2YgdGhlIGVudGl0eS5cblx0ICovXG5cdGFic3RyYWN0IGlkZW50aWZpZXJDb2x1bW5zKCk6IHN0cmluZ1tdO1xufVxuIl19